<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="xapax">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Port Scanning - Notes</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Port Scanning", url: "#_top", children: [
              {title: "TLDR", url: "#tldr" },
              {title: "Nmap", url: "#nmap" },
              {title: "Nessus", url: "#nessus" },
              {title: "Metasploit", url: "#metasploit" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../finding_subdomains/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../finding_subdomains/" class="btn btn-xs btn-link">
        Finding Subdomains
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../passive_information_gathering/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../passive_information_gathering/" class="btn btn-xs btn-link">
        Passive Information Gathering
      </a>
    </div>
    
  </div>

    

    <h1 id="port-scanning">Port Scanning<a class="headerlink" href="#port-scanning" title="Permanent link">#</a></h1>
<h2 id="tldr">TLDR<a class="headerlink" href="#tldr" title="Permanent link">#</a></h2>
<p><b>Always save the NMap output</b></p>
<pre><code>#Standard
nmap -T4 -p- 10.11.1.x -oA nmap_10111x.txt
Find open ports, then:
nmap -p ports,we,found -A 10.11.1.x &gt; portsnmap_10111x.txt

# Stealthy
nmap -sS 10.11.1.X

# Scan all ports, might take a while.
nmap 10.11.1.X -p-

# Scan for UDP
nmap 10.11.1.X -sU
unicornscan -mU -v -I 10.11.1.X

# Scan for version, with NSE-scripts and trying to identify OS
nmap 10.11.1.X -sV -sC -O

# All out monsterscan
nmap -vvv -Pn -A -iL listOfIP.txt

# Fast scan
nmap 10.11.1.X -F

# Only scan the 100 most common ports
nmap 10.11.1.X --top-ports 100
</code></pre>
<h2 id="nmap">Nmap<a class="headerlink" href="#nmap" title="Permanent link">#</a></h2>
<p><a href="https://nmap.org/book/">NMap Resource</a>
Now that you have gathered some IP addresses from your subdomain scanning it is time to scan those addresses. You just copy-paste those addresses and add them to a file, line by line. Then you can scan all of them with nmap at the same time. Using the <code>-iL</code> flag.</p>
<h3 id="switches-summary">Switches Summary<a class="headerlink" href="#switches-summary" title="Permanent link">#</a></h3>
<pre><code>#### Scan switches

-sS SYN Scan (Stealth scan)

-sU UDP Scan

-O The target's OS

-sV Version of services running on the target

-v or -vv Verbose

#### Output switches

Not all output works with grepable format. For example NSE does not work with grepable. So you might want to use xml instead.

-oA Save results in three major formats

-oN Save results to a text file

-oG Save the results in a grepable format

-oX Save results in an XML file


</code></pre>
<h3 id="basics">Basics<a class="headerlink" href="#basics" title="Permanent link">#</a></h3>
<h3 id="tcp-connect-scan">TCP Connect Scan<a class="headerlink" href="#tcp-connect-scan" title="Permanent link">#</a></h3>
<p>This is the default mode for nmap if run without sudo. If you do not add any flags and scan a machine this is the type of connection it creates.</p>
<p>Port state is determined with the 3-way handshake. A SYN packet is sent. The server will respond with:
RST if the port is closed
SYN/ACK if the port is open
nothing if the port is filtered (blocked by firewall) </p>
<p>A firewall could be configured to respond with a RST packet which makes it difficult to get an accurate reading of the target</p>
<h3 id="stealthy-ss">"Stealthy" -sS<a class="headerlink" href="#stealthy-ss" title="Permanent link">#</a></h3>
<p>This is the default mode for nmap if run with sudo</p>
<p>By adding the <code>-sS</code> flag we are telling nmap to not finalize the three way handshake. It will send a <code>syn</code>, receive <code>syn-ack</code> (if the port is open), and then terminate the connection with a <code>rst</code> packet. This used to be considered stealthy before, since it was often not logged. However it should not be considered stealthy anymore.</p>
<p>In the flag I imagine that the first <code>s</code> stands for scan/scantype and the second <code>S</code> stands for <code>syn</code>.</p>
<p>So <code>-sS</code> can be read as <strong>scantype syn</strong></p>
<h3 id="udp-scan">UDP scan<a class="headerlink" href="#udp-scan" title="Permanent link">#</a></h3>
<p>UDP is after TCP the most common protocol. DNS (53), SNMP (161/162) and DHCP (67/68) are some common ones. Scanning for it is slow and unreliable.</p>
<pre><code>-sU
</code></pre>
<h3 id="scan-an-entire-ip-range">Scan an entire IP-range<a class="headerlink" href="#scan-an-entire-ip-range" title="Permanent link">#</a></h3>
<p>You might find that a site has several machines on the same ip-range. You can then use nmap to scan the whole range.</p>
<p>The <code>-sn</code> flag stops nmap from running port-scans. So it speeds up the process.</p>
<pre><code>nmap -vvv -sn 201.210.67.0/24
</code></pre>
<p>You can also specify a specific range, like this</p>
<pre><code>nmap -sP 201.210.67.0-100
````

#### Sort out the machines that are up

So let's say you find that 40 machine exists in that range. We can use grep to output those IPs.

First let's find the IPs that were online. Ip-range is the output from previous command. You can of course combine them all.

```bash
cat ip-range.txt | grep -B 1 &quot;Host is up&quot;
</code></pre>
<p>Now let's sort out the ips from that file.</p>
<pre><code class="language-bash">grep -o '[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}' ip-range.txt &gt; only-ip.txt
</code></pre>
<p>Now you can input all those ips to nmap and scan them.</p>
<h4 id="scan-a-range-and-output-if-a-specific-port-is-open">Scan a range and output if a specific port is open<a class="headerlink" href="#scan-a-range-and-output-if-a-specific-port-is-open" title="Permanent link">#</a></h4>
<p>Nmap has a command to make the output grepable.</p>
<pre><code class="language-bash">nmap -vvv -p 80 201.210.67.0-100 -oG - | grep 80/open
</code></pre>
<h3 id="nmap-scripts">Nmap scripts<a class="headerlink" href="#nmap-scripts" title="Permanent link">#</a></h3>
<p>This chapter could also be placed in Vulnerability-analysis and Exploitation. Because nmap scripting is a really versatile tool that can do many things. Here we will focus on it's ability to retrieve information that can be useful in the process to <strong>find vulnerabilities</strong> 
NMap can also be used to automate exploits for vulns</p>
<p>First locate the nmap scripts. Can be found online: <a href="https://nmap.org/nsedoc/">NMap scripts</a></p>
<p>Nmap scripts end in <code>.nse</code>. For Nmap script engine (usually stored at /usr/share/nmap/scripts)</p>
<pre><code>locate *.nse

</code></pre>
<p>To see the file name and categories for installed scripts:</p>
<pre><code>head /usr/share/nmap/scripts/script.db
</code></pre>
<p>To search for scripts, e.g. ftp:</p>
<pre><code>ls -l /usr/share/nmap/scripts/*ftp*
</code></pre>
<p>The syntax for running a script is:</p>
<pre><code>nmap --script scriptname 192.168.1.101
</code></pre>
<p>To find the man pages/help for a script we write:</p>
<pre><code>nmap --script-help scriptname
</code></pre>
<p><strong>Run multiple scripts</strong></p>
<p>Can be run by separating the script with a comma</p>
<pre><code>nmap --script scriptone.nse,sciprt2.nse,script3.nse 192.168.1.101
</code></pre>
<p>Run the default scripts</p>
<pre><code>nmap -sC example.com
</code></pre>
<p>Firewall Evasion</p>
<p><a href="https://nmap.org/book/firewall-subversion.html">NMap Site</a></p>
<p>Common switches:</p>
<pre><code>-Pn Don't use ping and only scan the host. If done on a local network, NMap can use arp requests

-f Fragment packets (make smaller) so they're less likely to be detected

-mtu &lt;number&gt; Same as -f but provides control over the packet size. Must be in multiples of 8

--scan-delay &lt;time&gt;ms Adds a delay between packets sent. Helps for time-based firewall/IDS triggers that may be in place

</code></pre>
<p>Discover only live hosts without port scanning them:</p>
<pre><code>nmap -sn 192.168.0.1/24
</code></pre>
<h2 id="nessus">Nessus<a class="headerlink" href="#nessus" title="Permanent link">#</a></h2>
<p>This is good to use for scanning and reports</p>
<h3 id="navigation-and-scans">Navigation and scans<a class="headerlink" href="#navigation-and-scans" title="Permanent link">#</a></h3>
<p>Launch a scan</p>
<pre><code>New Scan
</code></pre>
<p>Create custom templates</p>
<pre><code>Policies
</code></pre>
<p>Change plugin properties, e.g. hide them</p>
<pre><code>Plugin Rules
</code></pre>
<p>See what hosts are alive</p>
<pre><code>New Scan - Scan Templates - Host Discovery
</code></pre>
<p>Authenticate to hosts and enumerate missing updates</p>
<pre><code>Credentialed Patch Audit
</code></pre>
<p>Scan Web Applications specifically</p>
<pre><code>Web Application Tests
</code></pre>
<p>Use a lower bandwidth connection</p>
<pre><code>Advanced - Scan low bandwidth links
</code></pre>
<h2 id="metasploit">Metasploit<a class="headerlink" href="#metasploit" title="Permanent link">#</a></h2>
<p>We can do port-scanning with metasploit and nmap. And we can even integrate nmap into metasploit. This might be a good way to keep your process neat and organized. </p>
<h3 id="initialise-the-database">Initialise the database<a class="headerlink" href="#initialise-the-database" title="Permanent link">#</a></h3>
<pre><code>sudo msfdb init
</code></pre>
<h3 id="ensure-were-connected-to-the-db">Ensure we're connected to the db<a class="headerlink" href="#ensure-were-connected-to-the-db" title="Permanent link">#</a></h3>
<pre><code>db_status
</code></pre>
<h3 id="db_nmap">db_nmap<a class="headerlink" href="#db_nmap" title="Permanent link">#</a></h3>
<p>You can run <code>db_nmap</code> and all the output will be stored in the metasploit database and available with </p>
<pre><code>hosts
services
</code></pre>
<p>You can also import nmap scans. But you must first output it in xml-format with the following flag  </p>
<pre><code>nmap 192.168.1.107 -oX result.xml
</code></pre>
<p>Good practice would be to output the scan-results in xml, grepable and normal format. You do that with</p>
<pre><code>nmap 192.168.1.107 -oA result
</code></pre>
<p>Then you can load it into the database with the following command. </p>
<pre><code>db_import /path/to/file.xml
</code></pre>
<h3 id="metasploit-portscan-modules">Metasploit PortScan modules<a class="headerlink" href="#metasploit-portscan-modules" title="Permanent link">#</a></h3>
<p>If you for some reason don't have access to nmap you can run metasploits modules that does portscans</p>
<pre><code>use auxiliary/scanner/portscan/
</code></pre>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../finding_subdomains/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../finding_subdomains/" class="btn btn-xs btn-link">
        Finding Subdomains
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../passive_information_gathering/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../passive_information_gathering/" class="btn btn-xs btn-link">
        Passive Information Gathering
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/xapax/edit/master/docs/recon/port_scanning.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>